#!/usr/bin/env bash
# Configures Nginx with a custom HTTP response header
# This script configures a brand new Ubuntu machine with Nginx
# and adds a custom X-Served-By header with the server's hostname

# Update package list and install Nginx
apt-get update -y
apt-get install -y nginx

# Get the hostname
# shellcheck disable=SC2154
hostname=$(hostname)

# Configure Nginx to add custom header
config_file="/etc/nginx/sites-available/default"

# Remove any existing X-Served-By headers to avoid duplicates
sed -i '/X-Served-By/d' "$config_file"

# Add custom header in the server block after the location / block starts
# This ensures it's properly placed within the server context
sed -i "/location \/ {/a \\\t\tadd_header X-Served-By $hostname;" "$config_file"

# Ensure Nginx is enabled to start on boot
systemctl enable nginx

# Test Nginx configuration
nginx -t

# Restart Nginx to apply changes
systemctl restart nginx

# Verify the configuration worked
sleep 2
if curl -sI localhost | grep -q "X-Served-By"; then
    echo "SUCCESS: X-Served-By header is configured"
else
    echo "ERROR: X-Served-By header not found"
fi